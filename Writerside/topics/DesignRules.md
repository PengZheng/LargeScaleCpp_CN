# 设计规则

## 第二章

* 任何架构显著的实体的名称必须在整个企业中唯一。（2.2.23）
* 组件文件（.h/.cpp）的根名称必须与组件本身的名称相同（仅在后缀上有所不同）。（2.4.6）
  * 推论：任何库组件的文件名必须在整个企业中唯一。（2.4.6）
* 任何组件都必须处于一个包中。（2.4.6）
* 任何组件的（全小写）名称必须以其所属包的（全小写）名称开头，后跟一个下划线（_）。（2.4.6）
* 在组件中声明的任何逻辑实体都必须嵌套在与该实体所属包同名的命名空间中。（2.4.6）
* 任何包级命名空间都必须嵌套在唯一的企业级命名空间中。（2.4.7）
* 在包级命名空间作用域中声明的任何逻辑结构的名称（自由运算符和切面函数除外，如运算符==和swap）必须以实现它的组件的基名作为前缀;
宏名称（全大写）在词法上不被限定在包级命名空间内，必须将组件的全大写名称（包括包前缀）整个作为前缀。（2.4.8）
  * 推论：在架构显著的组件头文件中声明的任何逻辑实体的完全限定名称（对函数或者运算符来说指的是签名）必须在整个企业中唯一。
* 在组件的.h文件内的包级命名空间作用域中只允许声明类、结构体和自由运算符（以及切面函数，比如 swap）。（2.4.9）
* 对于自由（非成员）运算符或（在包级命名空间作用域内的）切面函数来说，仅当其一个或多个参数包含在同一组件中定义的类型时，才允许在该组件头文件中声明它。（2.4.9）
* 不允许 using 指令或 using 声明出现在组件的函数作用域之外。（2.4.12）
* 一个组件必须仅包含一个 .h 文件和（至少）一个具有相同根名称的相应 .cpp 文件，它们一起满足组件的四个基本特性：（2.6）
  * 组件特性1：组件的 .cpp 文件第一行实质性代码用于包含其相应的 .h 文件。
    * 推论：每个组件的 .h 文件都必须可以独立编译。
  * 组件特性2：在组件的 .cpp 文件中定义的每个具有外部链接效果的逻辑结构都在该组件的 .h 文件中声明。
  * 组件特性3：在组件的 .h 文件中声明的每个具有外部绑定效果的逻辑结构（如果有定义）都在该组件中定义。
  * 组件特性4：组件的功能只能通过包含其头文件访问，而不能通过本地 extern 声明访问。
* 在定义 main 的文件之外编写的任何逻辑结构都必须放在某一个组件中。（2.6）
* 每个组件的 .h 文件都必须包含唯一且可预测的包含保护符：INCLUDED_PACKAGE_COMPONENTBASE（例如，INCLUDED_BDLT_DATETIME）。（2.6）
* 由组件导出的具有外部绑定或者双重绑定（比如内联函数）的逻辑结构必须先（在头文件中）声明，然后再（在同一组件中）单独定义，所有自由（比如运算符）函数都必须在声明它们的命名空间之外定义。（2.6）
  * 特别地，不要在类作用域中直接定义内联函数（双重绑定）以确保接口与实现分离。
* 禁止文件或命名空间作用域静态对象的运行时初始化。（2.6）
* 一个组件对另一个组件的任何直接实质性使用都要求在客户组件中（在 .h 文件或 .cpp 文件中，但不能同时）直接包含（`#include`）被使用组件的头文件，除非通过内在且实质性的编译时依赖（即公共继承，除此之外别无其他）已隐含地包含了该头文件。（2.6）
  * 推论：不允许使用传递包含，但允许访问已被直接包含其定义的类型的公共基类（而不用额外包含基类定义头文件）。
* 在逻辑名称中避免使用下划线字符（_）作为分隔符，除非作为两个全大写单词之间的分隔符或者作为既定的（小写）单字符前缀或后缀（例如，d_、s_、e_、k_和_p）。（2.7.3）
* 在组件头文件中的包级命名空间作用域声明的逻辑实体，若其名称中含有除作为有效分隔符（见上一条款）或作为附属组件基名一部分（见下一条款）的额外下划线的，则被视为是该组件的私有实体，不得从该组件以外的任何地方直接访问;
其小写名称中（第一个）额外下划线之前的部分必须与该组件的基名完全匹配。（2.7.3）
* 组件的基名中带有下划线表示该组件附属于（同一包中）的另一个组件，且后者的名称是前者基名中某个下划线之前（但不包括该下划线）的部分。（2.7.5）
* 必须明确说明每个包的预期可容许（直接）依赖。（2.8.1）
* 必须明确说明每个包组的预期可容许（直接）依赖。（2.9.1）
* 每个包组的（全小写）字母数字名称必须恰好三个字符，并且形成一个有效的标识符：（2.10.2）
```
<包组名> ::= [a-z] [a-z0-9] [a-z0-9]
```
* 包组中每个包的（全小写）名称必须以包组名开头，后跟一个、两个或三个全小写字母数字字符，用于在该包组中唯一区分出该包。（2.10.3）
```
  <包组内包的名称> ::= <包组名> [a-z0-9] ( [a-z0-9] ( [a-z0-9] )? )? 
```
* 每个独立包（不属于任何包组的包）的（全小写）名称必须以小写字母开头：
或者由6个以上字母数字字符组成；或正好由3个字母数字字符组成（极为罕见）；
或者后跟一个下划线、一个字母和零个或多个字母数字字符（注意，前缀“z_”有特殊含义，不包括在内）。（2.10.3）
```
  <独立包名> ::= <包组名> ( [a-z0-9] )4 ( [a-z0-9] )*
                | <包组名>                             极为罕见
                | [a-y] _ [a-z] ( [a-z0-9] )*         z_有特殊含义，不包括在内
```
* 应用（也可以说是应用级的“包”）可容许的名称必须有别于所有其他种类包的名称。（2.13）
* 应用包中的所有代码私有于该包，换言之，不允许外部代码依赖于应用包中的任何代码。（2.13）
* 每个组件必须关联（具有相同基名）一个唯一的、物理上独立的、具有一致后缀（比如 .t.cpp）的测试驱动程序。（2.14.3）
* 组件测试驱动程序与它测试的组件（物理上）位于同一目录中。（2.14.3）
* 测试驱动程序的分层直接（物理）依赖不得超过被测组件的依赖。（2.14.3）
* 测试驱动程序对不明确属于可移植测试环境的外部数据或其他设备的依赖不能超过被测组件对它们的依赖。（2.14.6）
* 在包含组件头文件时，禁止使用相对路径或者绝对路径。换言之， `#include` 中不得包含目录名。（2.15.1）
* 仅仅出于部署目的而采取的任何额外组织划分都不得具有架构显著性。（2.15.10）